<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Room</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
    #messages div { margin-bottom: 10px; }
    #replyInfo { margin-bottom: 5px; color: green; }
  </style>
</head>
<body>
  <h2>Chat Room</h2>
  <div id="messages"></div>
  <div id="replyInfo" style="display:none"></div>
  <form id="msgForm">
    <input type="text" id="message" placeholder="Type message" autocomplete="off" required style="width:80%">
    <button>Send</button>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const name = localStorage.getItem('chat_name');
    if (!name) {
      window.location.href = '/login.html';
    }
    const socket = io();
    let replyTo = null;

    function toIranTime(ts) {
      return new Date(ts).toLocaleString('fa-IR', { timeZone: 'Asia/Tehran' });
    }

    function addMsg(msg) {
      const div = document.createElement('div');
      const replyText = msg.reply_to ? ` (reply to #${msg.reply_to})` : '';
      div.innerHTML = `<strong>${msg.name}</strong> [${toIranTime(msg.timestamp)}]${replyText}: ${msg.text}`;
      const replyBtn = document.createElement('button');
      replyBtn.textContent = 'Reply';
      replyBtn.onclick = () => {
        replyTo = msg.id;
        document.getElementById('replyInfo').style.display = 'block';
        document.getElementById('replyInfo').textContent = `Replying to message #${msg.id}`;
      };
      div.appendChild(replyBtn);
      document.getElementById('messages').appendChild(div);
    }

    fetch('/messages').then(r => r.json()).then(data => {
      data.forEach(addMsg);
    });

    socket.on('broadcast-message', (msg) => {
      addMsg(msg);
    });

    document.getElementById('msgForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const text = document.getElementById('message').value.trim();
      if (!text) return;
      const msg = { name, text, timestamp: Date.now(), reply_to: replyTo };
      socket.emit('new-message', msg);
      document.getElementById('message').value = '';
      replyTo = null;
      document.getElementById('replyInfo').style.display = 'none';
    });
  </script>
</body>
</html>
